{%- assign items = site.data.nitrogen-gradient-sites -%}
{%- assign fields = site.data.config-map -%}
<!-- load leaflet dependencies -->
<script src="{{ '/leaflet/leaflet.js' | prepend: site.digital-assets }}"></script>
<script src="{{ '/leaflet/Leaflet.fullscreen.min.js' | prepend: site.digital-assets }}"></script>

<script>
    (function(){
        /* add collection map data */
        var geodata = { "type": "FeatureCollection", "features": [ 
        {% for item in items %}
        { "type":"Feature", "geometry":{ "type":"Point", "coordinates":[{{ item.longitude | strip }},{{ item.latitude | strip }}] }, "properties":
        { 
            {% for f in fields %}{% if item[f.field] %}{{ f.field | escape | jsonify }}:{{ item[f.field] | strip | escape | jsonify }}, {%- endif -%}{%- endfor -%}
            {% if item.image_thumb %}"img": {{ item.image_thumb | relative_url | jsonify }},{% endif %}
            {% if item.display_template %}"template": {{ item.display_template | escape | jsonify }}, {%- endif -%}
            {% if item.format %}"format": {{ item.format | escape | jsonify }}, {%- endif -%}
            {% if item.image_alt_text %}"alt": {{ item.image_alt_text | escape | jsonify }}, {%- endif -%}
            "title": {{ item.title | escape | jsonify }}, "link": "{% if item.parentid %}{{ item.parentid }}.html#{{ item.objectid }}{% else %}{{ item.objectid }}.html{% endif %}",
            "id": {{ item.objectid | jsonify }} 
        } }{% unless forloop.last %}, {% endunless %}{% endfor %}
        ]};
    
        /* check for url parameters and set initial view options */ 
        let url = new URL(window.location);
        const locationSearchParams = url.searchParams.get('location');
        var mapCenter = locationSearchParams ? locationSearchParams.split(',') : [{{ site.data.theme.latitude | default: 46.727485 }}, {{ site.data.theme.longitude | default: -117.014185 }}];
        var mapZoom = locationSearchParams ? 16 : {{ site.data.theme.zoom-level | default: 5 }};
        var markerFilter = url.searchParams.get('marker') ? url.searchParams.get('marker') : "";
    
        /* init map, set center and zoom */
        var map = L.map('map');
    
        /* add map layer options */
        var Esri_WorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
        });
        var Esri_NatGeoWorldMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC',
            maxZoom: 16
        });
        var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });
        var OpenStreetMap_Mapnik = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        /* add base map switcher */
        var baseMaps = {
            "Esri World StreetMap": Esri_WorldStreetMap,
            "Esri National Geo": Esri_NatGeoWorldMap,
            "Esri Imagery": Esri_WorldImagery,
            "Open Street Map": OpenStreetMap_Mapnik
        };
        L.control.layers(baseMaps).addTo(map);
        /* load base map */
        {{ site.data.theme.map-base | default: 'Esri_WorldStreetMap' }}.addTo(map);
    
        /* add fullscreen control */ 
        map.addControl(new L.Control.Fullscreen());
    
        /* get icons function */ 
        {% include helpers/get-icon.js %}
    
        /* object popup function */
        function objectPopups(feature, layer) {
            
            // set up popup content
            var popupTemplate = '<h2 class="h4">' + feature.properties.title + '</h2><p>';
            {% for f in fields %}{% if f.display_name %}
            if (feature.properties[{{ f.field | escape | jsonify }}]) {
                popupTemplate += '<strong>{{ f.display_name }}:</strong> ' + feature.properties[{{ f.field | escape | jsonify }}] + '<br>'; 
            }
            {% endif %}{% endfor %}
            popupTemplate += '</p>';
            layer.bindPopup(popupTemplate);
        }
        function objectMarkers(feature,latlng) {
            var marker = L.marker(latlng, {alt: feature.properties.title});
            return marker;
        }
    
        /* add objects from geoJson features */
        var mapFeatures = L.geoJson(geodata, {
            onEachFeature: objectPopups,
            pointToLayer: objectMarkers
        }).addTo(map);

        /* if no location was specified in the URL query parameters, auto center the map */
        if (locationSearchParams === null) {
            const featureBounds = mapFeatures.getBounds()
            if (featureBounds?.isValid()) {
                map.fitBounds(featureBounds);
            }
        } else {
            /* set map view based on URL parameters */
            map.setView(mapCenter, mapZoom);
        }
        
        /* show popup if id in URL query */ 
    if (markerFilter != "") {
        mapFeatures.eachLayer(layer => {
            if (layer.feature.properties.id === markerFilter) {
                layer.openPopup();
            }
        });
    }
    
})();

</script>